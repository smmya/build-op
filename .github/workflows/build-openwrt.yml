
name: Build OpenWrt

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'
        
env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  REPO_URL_LIENOL: https://github.com/Lienol/openwrt
  REPO_BRANCH_LIENOL: 21.02
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: .config
  TZ: Asia/Shanghai
  DEVICE1: new3
  DEVICE2: r3g
  DEVICE3: n1-docker
  DEVICE4: n1-flash
  UPLOAD_DOCKERHUB: true
  UPLOAD_OUTPUT: true

jobs:
   
  
   n1-flash:
    runs-on: ubuntu-20.04
    permissions:
      contents: write

    steps:
    - name: Checkout
      uses: actions/checkout@master
    
    - name: load environment
      env:
          DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get -qq update
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir
  
    
    - name: dlop
      run: |
        mkdir openwrt
        cd openwrt
        mkdir bin
        cd bin
        mkdir targets
        cd targets
        mkdir armvirt
        cd armvirt
        mkdir 64
        cd 64
        wget -O openwrt-armvirt-64-rootfs.tar.gz  https://github.com/smmya/build-op/releases/download/n1-flash--202311081440/flash-openwrt-armvirt-64-generic-rootfs.tar.gz
        
    - name: Package Armvirt as OpenWrt
      uses: unifreq/openwrt_packit@master
      env:
         OPENWRT_ARMVIRT: openwrt/bin/targets/armvirt/64/openwrt-armvirt-64-rootfs.tar.gz
         PACKAGE_SOC: s905d
         KERNEL_VERSION_NAME: 6.1.99
         SCRIPT_S905D: mk_s905d_n1.sh
         KERNEL_AUTO_LATEST: false 
         
    - name: sync image
      run: |
       sudo -E rm -rf $GITHUB_WORKSPACE/openwrt/bin/targets/armvirt/64/openwrt-armvirt-64-rootfs.tar.gz
       sudo -E cp -r /opt/openwrt_packit/output/* $GITHUB_WORKSPACE/openwrt/bin/targets/armvirt/64
       sudo -E ls -sh
       sudo -E rm -rf $GITHUB_WORKSPACE/openwrt/bin/targets/armvirt/64/openwrt-armvirt-64-rootfs.tar.gz

    - name : Upload artifact
      uses: actions/upload-artifact@master
      if: env.UPLOAD_OUTPUT == 'true' && !cancelled()
      with:
        name: Op-${{ env.DEVICE4 }}
        path: openwrt/bin
        
    
    - name: Upload firmware to release
      uses: ncipollo/release-action@v1
      with:
        artifacts: "openwrt/bin/targets/*/*/*"
        body: "192.168.123.253_password"
